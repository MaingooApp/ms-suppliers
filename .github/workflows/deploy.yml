name: Build and Deploy Suppliers to Azure

on:
  push:
    branches:
      - production
  workflow_dispatch:

env:
  AZURE_REGISTRY_NAME: maingooregistry
  SERVICE_NAME: suppliers
  TARGET_PORT: 3004
  IMAGE_TAG: ${{ github.sha }}
  ACR_LOGIN_SERVER: maingooregistry.azurecr.io
  RESOURCE_GROUP: maingoo-back
  CONTAINER_APP_NAME: ms-suppliers

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîê Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ secrets.AZURE_REGISTRY_USERNAME }}
          password: ${{ secrets.AZURE_REGISTRY_PASSWORD }}

      - name: üèóÔ∏è Build Docker image
        run: |
          docker build \
            -t ${{ env.ACR_LOGIN_SERVER }}/maingoo-${{ env.SERVICE_NAME }}:${{ env.IMAGE_TAG }} \
            -t ${{ env.ACR_LOGIN_SERVER }}/maingoo-${{ env.SERVICE_NAME }}:latest \
            -f dockerfile.prod \
            .

      - name: üì§ Push Docker image
        run: |
          docker push ${{ env.ACR_LOGIN_SERVER }}/maingoo-${{ env.SERVICE_NAME }}:${{ env.IMAGE_TAG }}
          docker push ${{ env.ACR_LOGIN_SERVER }}/maingoo-${{ env.SERVICE_NAME }}:latest

      - name: ‚úÖ Build completed
        run: |
          echo "‚úÖ Image maingoo-${{ env.SERVICE_NAME }}:${{ env.IMAGE_TAG }} built and pushed!"

  deploy-to-azure:
    name: Deploy to Azure Container Apps
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - name: üîê Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: üì¶ Install Azure Container Apps extension
        run: az extension add -n containerapp --upgrade

      - name: üîë Ensure ACR credentials on Container App
        run: |
          az containerapp registry set \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --server ${{ env.ACR_LOGIN_SERVER }} \
            --username ${{ secrets.AZURE_REGISTRY_USERNAME }} \
            --password ${{ secrets.AZURE_REGISTRY_PASSWORD }}

      - name: üöÄ Deploy new revision with new image
        run: |
          az containerapp update \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_LOGIN_SERVER }}/maingoo-${{ env.SERVICE_NAME }}:${{ env.IMAGE_TAG }}

      - name: üìã Show active revision
        run: |
          az containerapp revision list \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[?properties.active==\`true\`].{name:name,image:properties.template.containers[0].image}" -o table

      - name: ‚úÖ Deployment successful
        run: |
          echo "‚úÖ Service maingoo-${{ env.SERVICE_NAME }} deployed successfully!"
          echo "üîó View logs: az containerapp logs show --name ${{ env.CONTAINER_APP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --follow"
