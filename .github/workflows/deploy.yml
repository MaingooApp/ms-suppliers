name: Build and Deploy Suppliers to Azure

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  AZURE_REGISTRY_NAME: maingooregistry
  SERVICE_NAME: suppliers
  TARGET_PORT: 3004
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîê Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.AZURE_REGISTRY_NAME }}.azurecr.io
          username: ${{ secrets.AZURE_REGISTRY_USERNAME }}
          password: ${{ secrets.AZURE_REGISTRY_PASSWORD }}

      - name: üèóÔ∏è Build Docker image
        run: |
          docker build \
            -t ${{ env.AZURE_REGISTRY_NAME }}.azurecr.io/maingoo-${{ env.SERVICE_NAME }}:${{ env.IMAGE_TAG }} \
            -t ${{ env.AZURE_REGISTRY_NAME }}.azurecr.io/maingoo-${{ env.SERVICE_NAME }}:latest \
            -f dockerfile.prod \
            .

      - name: üì§ Push Docker image
        run: |
          docker push ${{ env.AZURE_REGISTRY_NAME }}.azurecr.io/maingoo-${{ env.SERVICE_NAME }}:${{ env.IMAGE_TAG }}
          docker push ${{ env.AZURE_REGISTRY_NAME }}.azurecr.io/maingoo-${{ env.SERVICE_NAME }}:latest

      - name: ‚úÖ Build completed
        run: |
          echo "‚úÖ Image maingoo-${{ env.SERVICE_NAME }}:${{ env.IMAGE_TAG }} built and pushed!"

  deploy-to-azure:
    name: Deploy to Azure Container Apps
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - name: üîê Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: üöÄ Update Container App
        run: |
          az containerapp update \
            --name ms-${{ env.SERVICE_NAME }} \
            --resource-group maingoo-back \
            --image ${{ env.AZURE_REGISTRY_NAME }}.azurecr.io/maingoo-${{ env.SERVICE_NAME }}:${{ env.IMAGE_TAG }}

      - name: ‚úÖ Deployment successful
        run: |
          echo "‚úÖ Service maingoo-${{ env.SERVICE_NAME }} deployed successfully!"
          echo "üîó View logs: az containerapp logs show --name maingoo-${{ env.SERVICE_NAME }} --resource-group maingoo-back --follow"
