generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Supplier {
  id                         String            @id @default(cuid())
  enterpriseId               String
  name                       String
  cifNif                     String
  address                    String?
  phoneNumber                String?
  commercialName             String?
  commercialPhoneNumber      String?
  deliveryDays               String?
  minPriceDelivery           Decimal?          @db.Decimal(10, 2)
  sanitaryRegistrationNumber String?
  createdAt                  DateTime          @default(now())
  updatedAt                  DateTime          @updatedAt

  invoices                   Invoice[]
  supplierProducts           SupplierProduct[]

  @@unique([cifNif, enterpriseId])
  @@index([enterpriseId])
}

model Invoice {
  id             String        @id @default(cuid())
  enterpriseId   String
  supplierId     String
  type           String?
  invoiceNumber  String?
  blobName       String?       // Referencia al archivo en Azure Blob Storage
  amount         Decimal       @db.Decimal(12, 2)
  date           DateTime
  createdAt      DateTime      @default(now())

  supplier       Supplier      @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  invoiceLines   InvoiceLine[]
  hasDeliveryNotes Boolean @default(false)
  documentType String

  @@index([enterpriseId])
  @@index([supplierId])
  @@index([invoiceNumber])
}

model InvoiceLine {
  id                 String           @id @default(cuid())
  invoiceId          String
  suppliersProductId String?
  masterProductId    String?          // ID del producto maestro en products-service (para referencia directa)
  productCode        String?          // Código del producto del proveedor
  description        String?
  productUnit        String?          // Unidad de medida (kg, ud, etc.)
  unitCount          String?          // Cantidad por unidad
  quantity           Decimal          @db.Decimal(10, 3)
  unitPrice          Decimal          @db.Decimal(12, 2)
  linePrice          Decimal?         @db.Decimal(12, 2)  // Precio de línea antes de impuestos
  price              Decimal?         @db.Decimal(12, 2)  // Precio total de línea (LineAmount)
  tax                String?
  discountCode       String?          // Código de descuento aplicado
  additionalReference String?         // Referencia adicional
  createdAt          DateTime         @default(now())

  invoice            Invoice          @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  supplierProduct    SupplierProduct? @relation(fields: [suppliersProductId], references: [id])

  @@index([invoiceId])
  @@index([suppliersProductId])
  @@index([masterProductId])
}

model SupplierProduct {
  id               String        @id @default(cuid())
  productReference String?       // Referencia/código del proveedor para este producto
  masterProductId  String?       // ID del producto maestro en products-service (sin FK por microservicios)
  supplierId       String
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  supplier         Supplier      @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  invoiceLines     InvoiceLine[]

  @@index([supplierId])
  @@index([masterProductId])
}
